// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Address {
  id        String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  city      String     @db.VarChar
  zone      String     @db.VarChar
  detail    String     @db.VarChar
  latitude  Float?
  longitude Float?
  active    Boolean    @default(true)
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @default(now()) @updatedAt @map("updated_at")
  createdBy String     @map("created_by")
  branches  Branch[]
  users     User[]
  providers Provider[]

  @@map("addresses")
}

model User {
  id              String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  addressId       String?          @map("address_id") @db.Uuid
  numberDocument  String           @unique @map("number_document") @db.VarChar
  typeDocument    TypeDocument     @default(dni) @map("type_document")
  name            String           @db.VarChar
  lastName        String           @map("last_name") @db.VarChar
  email           String           @unique @db.VarChar
  active          Boolean          @default(true)
  codeActivation  String?          @map("code_activation") @db.VarChar
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  createdBy       String           @map("created_by")
  customer        Customer?
  staff           Staff?
  sessions        Session[]
  forgotPasswords forgotPassword[]
  auditLogs       AuditLog[]
  address         Address?         @relation(fields: [addressId], references: [id])

  @@map("users")
}

model Session {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique @db.VarChar
  ipAddress String   @map("ip_address") @db.VarChar
  userAgent String   @map("user_agent") @db.VarChar
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  user      User     @relation(fields: [userId], references: [id])

  @@map("sessions")
}

model forgotPassword {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  code      String   @db.VarChar
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String   @map("created_by")
  user      User     @relation(fields: [userId], references: [id])

  @@map("forgot_passwords")
}

model Customer {
  userId    String   @unique @map("user_id") @db.Uuid
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String   @map("created_by")
  user      User     @relation(fields: [userId], references: [id])
  orders    Order[]

  @@map("customers")
}

model Staff {
  userId                 String   @unique @map("user_id") @db.Uuid
  roleId                 String   @map("role_id") @db.Uuid
  password               String   @db.VarChar
  requiresPasswordChange Boolean  @default(true)
  active                 Boolean  @default(true)
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")
  createdBy              String   @map("created_by")
  user                   User     @relation(fields: [userId], references: [id])
  role                   Role     @relation(fields: [roleId], references: [id])
  branches               Branch[]
  orders                 Order[]

  @@id([userId])
  @@map("staffs")
}

model Role {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  branchId    String       @map("branch_id") @db.Uuid
  name        String       @db.VarChar
  active      Boolean      @default(true)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  createdBy   String       @map("created_by")
  branch      Branch       @relation(fields: [branchId], references: [id])
  permissions Permission[]
  staffs      Staff[]

  @@map("roles")
}

model Permission {
  id         String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  action     TypeAction
  subject    String
  inverted   Boolean     @default(false)
  reason     String?     @db.Text
  active     Boolean     @default(true)
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @default(now()) @updatedAt @map("updated_at")
  createdBy  String      @map("created_by")
  roles      Role[]
  conditions Condition[]

  @@map("permissions")
}

model Condition {
  id           String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  permissionId String            @map("permission_id") @db.Uuid
  field        String
  operator     ConditionOperator
  value        String
  active       Boolean           @default(true)
  createdAt    DateTime          @default(now()) @map("created_at")
  updatedAt    DateTime          @default(now()) @updatedAt @map("updated_at")
  createdBy    String            @map("created_by")
  permission   Permission        @relation(fields: [permissionId], references: [id])

  @@map("conditions")
}

model Provider {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  addressId String?   @map("address_id") @db.Uuid
  nit       String
  phone     String[]
  name      String    @db.VarChar
  active    Boolean   @default(true)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  createdBy String    @map("created_by")
  address   Address?  @relation(fields: [addressId], references: [id])
  products  Product[]

  @@map("providers")
}

model Brand {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String    @db.VarChar
  description String    @db.VarChar
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  createdBy   String    @map("created_by")
  products    Product[]

  @@map("brands")
}

model Category {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String    @db.VarChar
  active    Boolean   @default(true)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  createdBy String    @map("created_by")
  products  Product[]

  @@map("categories")
}

model Product {
  id                   String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  categoryId           String                @map("category_id") @db.Uuid
  brandId              String                @map("brand_id") @db.Uuid
  providerId           String                @map("provider_id") @db.Uuid
  code                 String?               @db.VarChar
  name                 String                @db.VarChar
  image                String?               @db.VarChar
  barCode              String?               @map("bar_code") @db.VarChar
  visible              Boolean               @default(true)
  active               Boolean               @default(true)
  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @updatedAt @map("updated_at")
  createdBy            String                @map("created_by")
  category             Category              @relation(fields: [categoryId], references: [id])
  brand                Brand                 @relation(fields: [brandId], references: [id])
  provider             Provider              @relation(fields: [providerId], references: [id])
  productPresentations ProductPresentation[]
  unitConversions      UnitConversion[]

  @@map("products")
}

model ProductPresentation {
  id        String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code      String?    @db.VarChar
  productId String     @map("product_id") @db.Uuid
  branchId  String     @map("branch_id") @db.Uuid
  name      String     @map("name") @db.VarChar
  typeUnit  TypeUnit   @map("type_unit")
  active    Boolean    @default(true)
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")
  createdBy String     @map("created_by")
  product   Product    @relation(fields: [productId], references: [id])
  branch    Branch     @relation(fields: [branchId], references: [id])
  prices    Price[]
  inputs    Input[]
  outputs   Output[]
  kardexs   Kardex[]
  transfers Transfer[]

  @@unique([productId, branchId, typeUnit])
  @@map("product_presentations")
}

model Price {
  id                    String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productPresentationId String              @map("product_presentation_id") @db.Uuid
  price                 Float               @default(0.0)
  discount              Float               @default(0.0)
  typeDiscount          TypeDiscount        @default(monto) @map("type_discount")
  changedReason         String              @default("creado") @map("changed_reason")
  active                Boolean             @default(true)
  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")
  createdBy             String              @map("created_by")
  productPresentation   ProductPresentation @relation(fields: [productPresentationId], references: [id])

  @@map("prices")
}

model UnitConversion {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId String   @map("product_id") @db.Uuid
  fromUnit  TypeUnit @map("from_unit")
  toUnit    TypeUnit @map("to_unit")
  factor    Int
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String   @map("created_by")
  product   Product  @relation(fields: [productId], references: [id])

  @@unique([productId, fromUnit, toUnit])
  @@map("unit_conversions")
}

model Branch {
  id                   String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  addressId            String?               @map("address_id") @db.Uuid
  name                 String                @db.VarChar
  bankAccount          String?
  phone                String[]
  active               Boolean               @default(true)
  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @updatedAt @map("updated_at")
  createdBy            String                @map("created_by")
  staffs               Staff[]
  karedxs              Kardex[]
  inputs               Input[]
  outputs              Output[]
  orders               Order[]
  roles                Role[]
  productPresentations ProductPresentation[]
  fromTransfers        Transfer[]            @relation("TransferFromBranch")
  toTransfers          Transfer[]            @relation("TransferToBranch")
  address              Address?              @relation(fields: [addressId], references: [id])

  @@map("branches")
}

model Input {
  id                    String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  branchId              String              @map("branch_id") @db.Uuid
  transferId            String?             @map("transfer_id") @db.Uuid
  productPresentationId String              @map("product_presentation_id") @db.Uuid
  quantity              Int                 @db.Integer
  price                 Float               @default(0.0)
  dueDate               DateTime?           @map("due_date") @db.Date
  detail                String              @db.VarChar
  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")
  createdBy             String              @map("created_by")
  branch                Branch              @relation(fields: [branchId], references: [id])
  transfer              Transfer?           @relation(fields: [transferId], references: [id])
  productPresentation   ProductPresentation @relation(fields: [productPresentationId], references: [id])

  @@map("inputs")
}

model Output {
  id                    String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  branchId              String              @map("branch_id") @db.Uuid
  orderId               String?             @map("order_id") @db.Uuid
  transferId            String?             @map("transfer_id") @db.Uuid
  productPresentationId String              @map("product_presentation_id") @db.Uuid
  quantity              Int                 @db.Integer
  price                 Float               @default(0.0)
  detail                String              @db.VarChar
  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")
  createdBy             String              @map("created_by")
  branch                Branch              @relation(fields: [branchId], references: [id])
  order                 Order?              @relation(fields: [orderId], references: [id])
  transfer              Transfer?           @relation(fields: [transferId], references: [id])
  productPresentation   ProductPresentation @relation(fields: [productPresentationId], references: [id])

  @@map("outputs")
}

model Kardex {
  branchId              String              @map("branch_id") @db.Uuid
  productPresentationId String              @map("product_presentation_id") @db.Uuid
  referenceId           String              @map("reference_id") @db.Uuid
  typeReference         TypeReference       @map("type_reference")
  stock                 Int                 @db.Integer
  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")
  createdBy             String              @map("created_by")
  productPresentation   ProductPresentation @relation(fields: [productPresentationId], references: [id])
  branch                Branch              @relation(fields: [branchId], references: [id])

  @@unique([referenceId, typeReference])
  @@map("kardexs")
}

model Transfer {
  id                    String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  fromBranchId          String              @map("from_branch_id") @db.Uuid
  toBranchId            String              @map("to_branch_id") @db.Uuid
  productPresentationId String              @map("product_presentation_id") @db.Uuid
  quantity              Int                 @db.Integer
  price                 Float               @default(0.0)
  detail                String?             @db.VarChar
  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")
  createdBy             String              @map("created_by")
  fromBranch            Branch              @relation("TransferFromBranch", fields: [fromBranchId], references: [id])
  toBranch              Branch              @relation("TransferToBranch", fields: [toBranchId], references: [id])
  productPresentation   ProductPresentation @relation(fields: [productPresentationId], references: [id])
  outputs               Output[]
  inputs                Input[]

  @@map("transfers")
}

model Order {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  staffId    String   @map("staff_id") @db.Uuid
  customerId String   @map("customer_id") @db.Uuid
  branchId   String   @map("branch_id") @db.Uuid
  url        String?  @db.VarChar
  amount     Float    @default(0.0)
  active     Boolean  @default(true) @db.Boolean
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  createdBy  String   @map("created_by")
  staff      Staff    @relation(fields: [staffId], references: [userId])
  customer   Customer @relation(fields: [customerId], references: [userId])
  branch     Branch   @relation(fields: [branchId], references: [id])
  outputs    Output[]

  @@map("orders")
}

model AuditLog {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  action      String // 'CREATE', 'UPDATE', 'DELETE'
  entity      String // Nombre de la tabla: 'Price', 'Product', etc.
  entityId    String   @map("entity_id") @db.Uuid
  dataBefore  Json?    @map("data_before") // Estado anterior (si aplica)
  dataAfter   Json?    @map("data_after") // Estado nuevo (si aplica)
  timestamp   DateTime @default(now())
  description String? // Mensaje opcional ("Cambio de precio por inflación")
  user        User     @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

// emuns section
enum TypeDocument {
  dni
  pasaporte
}

enum MethodPay {
  cash
  qr
  deposit
}

enum TypeDiscount {
  monto
  porcentaje
}

enum TypeUnit {
  UNIDAD
  CAJA
  DOCENA
}

enum TypeReference {
  inputs
  outputs
}

enum TypeAction {
  manage
  create
  read
  update
  delete
}

enum ConditionOperator {
  equals // es igual
  not_equals // no es igual
  in // está dentro de una lista de valores
  not_in // no está dentro de una lista de valores
  greater_than // es mayor que
  greater_than_or_equal // es mayor o igual que
  less_than // es menor que
  less_than_or_equal // es menor o igual que
  contains // contiene un valor (usado en cadenas de texto o arrays)
  starts_with // empieza con un valor (solo para strings)
  ends_with // termina con un valor (solo para strings)
  exists // verifica si el campo existe o no (útil para valores opcionales)
  between
}
